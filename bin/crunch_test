#!/bin/bash

do_test () {
    n=$1
    depthdiff=$2
    modpath=$3
    controllerpath=$4
    workpath=$5

    echo "\$# = ${n}"
    echo "\${depthdiff} = ${depthdiff}"
    echo ${modpath}
    echo ${controllerpath}
    echo ${workpath}
    echo ""
}

startpath=$(cd $1; pwd -P)
origdepth=$(echo ${startpath} | grep -o / | wc -l)
depth=$(find ${startpath} -mindepth 1 -type d -name jobs -exec bash -c 'echo '{}' 2>/dev/null | grep -o / | wc -l' \; -quit)
if [[ "${depth}" == "" ]]
then
    depthdiff=0
else
    depthdiff=$((${depth}-${origdepth}))
fi

case $# in
    1)
        case ${depthdiff} in
            0)
                modnames=($(echo ${startpath} | rev | cut -d'/' -f3 | rev))
                controllernames=($(echo ${startpath} | rev | cut -d'/' -f2 | rev))
                ;;
            1)
                modnames=($(echo ${startpath} | rev | cut -d'/' -f2 | rev))
                controllernames=($(echo ${startpath} | rev | cut -d'/' -f1 | rev))
                ;;
            2)
                modnames=($(echo ${startpath} | rev | cut -d'/' -f1 | rev))
                controllernames=($(find ${startpath}/ -maxdepth 1 -type d | rev | cut -d'/' -f1 | rev))
                ;;
            3)
                modnames=($(find ${startpath}/ -maxdepth 1 -type d | rev | cut -d'/' -f1 | rev))
                controllernames=()
                ;;
            *)
                echo "Error: You are currently in the ${startpath} directory. You must be inside a modules directory."
                exit 1
                ;;
        esac
        ;;
    2)
        case ${depthdiff} in
            0)
                modnames=($(echo ${startpath} | rev | cut -d'/' -f3 | rev))
                controllernames=($2)
                ;;
            1)
                modnames=($(echo ${startpath} | rev | cut -d'/' -f2 | rev))
                controllernames=($2)
                ;;
            2)
                modnames=($(echo ${startpath} | rev | cut -d'/' -f1 | rev))
                controllernames=($2)
                ;;
            3)
                modnames=($2)
                controllernames=()
                ;;
            *)
                echo "Error: You are currently in the ${startpath} directory. You must be inside a modules directory."
                exit 1
                ;;
        esac
        ;;
    3)
        modnames=($2)
        controllernames=($3)
        ;;
    *)
        echo "Error: You must provide no more than 3 arguments. $# provided."
        exit 1
        ;;
esac

case ${#modnames[@]} in
    1)
        modname="${modnames[0]}"
        modpath="$(echo ${startpath} | sed -E "s/\/${modname}(\/.*|$)//g")/${modname}"

        if [ ! -d "${modpath}" ]
        then
            mkdir ${modpath}
        fi

        case ${#controllernames[@]} in
            0)
                controllernames=($(find ${modpath}/ -maxdepth 1 -type d | rev | cut -d'/' -f1 | rev))

                for controllername in ${controllernames[@]}
                do
                    controllerpath="${modpath}/${controllername}"

                    if [ ! -d "${controllerpath}" ]
                    then
                        mkdir ${controllerpath}
                    fi

                    workpath="${controllerpath}/jobs"

                    if [ ! -d "${workpath}" ]
                    then
                        mkdir ${workpath}
                    fi

                    do_test $# ${depthdiff} ${modpath} ${controllerpath} ${workpath}
                done
                ;;
            1)
                controllername="${controllernames[0]}"
                controllerpath="${modpath}/${controllername}"

                if [ ! -d "${controllerpath}" ]
                then
                    mkdir ${controllerpath}
                fi

                workpath="${controllerpath}/jobs"

                if [ ! -d "${workpath}" ]
                then
                    mkdir ${workpath}
                fi

                do_test $# ${depthdiff} ${modpath} ${controllerpath} ${workpath}
                ;;
            *)
                for controllername in ${controllernames[@]}
                do
                    controllerpath="${modpath}/${controllername}"

                    if [ ! -d "${controllerpath}" ]
                    then
                        mkdir ${controllerpath}
                    fi

                    workpath="${controllerpath}/jobs"

                    if [ ! -d "${workpath}" ]
                    then
                        mkdir ${workpath}
                    fi

                    do_test $# ${depthdiff} ${modpath} ${controllerpath} ${workpath}
                done
                ;;
        esac
        ;;
    *)
        for modname in ${modnames[@]}
        do
            modpath="$(echo ${startpath} | sed -E "s/\/${modname}(\/.*|$)//g")/${modname}"

            if [ ! -d "${modpath}" ]
            then
                mkdir ${modpath}
            fi

            controllernames=($(find ${modpath}/ -maxdepth 1 -type d | rev | cut -d'/' -f1 | rev))

            for controllername in ${controllernames[@]}
            do
                controllerpath="${modpath}/${controllername}"

                if [ ! -d "${controllerpath}" ]
                then
                    mkdir ${controllerpath}
                fi

                workpath="${controllerpath}/jobs"

                if [ ! -d "${workpath}" ]
                then
                    mkdir ${workpath}
                fi

                do_test $# ${depthdiff} ${modpath} ${controllerpath} ${workpath}
            done
        done
        ;;
esac