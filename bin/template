#!/bin/bash

modulespath="${CRUNCH_ROOT}/modules/modules"
startpath=$(cd $1; pwd -P)
#binpath="${CRUNCH_ROOT}/bin"

case $# in
    1)
        if [[ "${startpath}" =~ .*"/jobs"$ ]]
        then
            workpath="${startpath}"
            startpath=$(echo ${startpath} | rev | cut -d'/' -f1 --complement | rev)
        else
            workpath="${startpath}/jobs"
        fi

        controllername=$(echo ${startpath} | rev | cut -d'/' -f1 | rev)
        modname=$(echo ${startpath} | rev | cut -d'/' -f2 | rev)
        
        controllerpath="${startpath}"
        modpath=$(echo ${controllerpath} | rev | cut -d'/' -f1 --complement | rev)
        ;;
    2)
        controllername=$2

        modpath=$(echo ${startpath} | sed -E "s/\/${controllername}(\/.*|$)//g")
        modname=$(echo ${modpath} | rev | cut -d'/' -f1 | rev)
        controllerpath="${modpath}/${controllername}"
        workpath="${controllerpath}/jobs"
        ;;
    3)
        modname=$2
        controllername=$3

        startpath=$(echo ${startpath} | sed -E "s/\/${modname}(\/.*|$)//g")

        modpath="${startpath}/${modname}"
        controllerpath="${modpath}/${controllername}"
        workpath="${controllerpath}/jobs"
        ;;
esac

if [ ! -d "${modpath}" ]
then
    mkdir ${modpath}
fi

if [ ! -d "${controllerpath}" ]
then
    mkdir ${controllerpath}
fi

if [ ! -d "${workpath}" ]
then
    mkdir ${workpath}
fi

#cp "${binpath}/reset.bash" "${controllerpath}/"
cp -T "${modulespath}/${modname}/${modname}_slurm.job" "${controllerpath}/crunch_${modname}_${controllername}_controller.job"
echo "JobStep,ExitCode,Resubmit?" > ${controllerpath}/skipped 2>/dev/null
echo -e "BatchCounter,StepCounter\n1,1" > ${controllerpath}/batchcounter 2>/dev/null
echo "Pending" > ${controllerpath}/status 2>/dev/null

modulesworkpath=$(echo ${modpath} | rev | cut -d'/' -f1 --complement | rev)

files=$(find "${controllerpath}/" -mindepth 1 -type f)
for file in ${files}
    do
        #perl -i -pe 's|#SBATCH(.*)\${CRUNCH_ROOT}|#SBATCH\1'"${CRUNCH_ROOT}"'|g' ${file}
        sed -i "s|path\_to\_module|${modulesworkpath}|g" ${file}
        sed -i "s|template|${controllername}|g" ${file}
        #newfile=$(echo "${file}" | sed "s/template/${controllername}/g")
        #mv ${file} ${newfile} 2>/dev/null
    done