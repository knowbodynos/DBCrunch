#!/bin/bash

templatespath="${CRUNCH_ROOT}/modules/templates"
#binpath="${CRUNCH_ROOT}/bin"

case $# in
    1)
        controllerpath=$1

        modname="$(echo ${controllerpath} | rev | cut -d'/' -f2 | rev)"
        controllername="$(echo ${controllerpath} | rev | cut -d'/' -f1 | rev)"
        ;;
    2)
        controllerpath=$1
        controllername=$2
        
        if ! [[ "${controllerpath}" =~ .*"/${controllername}/".* ]] && ! [[ "${controllerpath}" =~ ^"${controllername}/".* ]] && ! [[ "${controllerpath}" =~ .*"/${controllername}"$ ]]
        then
            controllerpath="${controllerpath}/${controllername}"
        fi
        modname="$(echo ${controllerpath} | rev | cut -d'/' -f2 | rev)"
        ;;
    3)
        controllerpath=$1
        modname=$2
        controllername=$3

        if ! [[ "${controllerpath}" =~ .*"/${modname}/".* ]] && ! [[ "${controllerpath}" =~ ^"${modname}/".* ]] && ! [[ "${controllerpath}" =~ .*"/${modname}"$ ]]
        then
            controllerpath="${controllerpath}/${modname}"
        fi

        if [ ! -d "${controllerpath}" ]
        then
            mkdir ${controllerpath}
        fi

        if ! [[ "${controllerpath}" =~ .*"/${controllername}/".* ]] && ! [[ "${controllerpath}" =~ ^"${controllername}/".* ]] && ! [[ "${controllerpath}" =~ .*"/${controllername}"$ ]]
        then
            controllerpath="${controllerpath}/${controllername}"
        fi
        ;;
esac

if [[ "${controllerpath}" =~ .*"/jobs"$ ]]
then
    controllerpath="$(echo ${controllerpath} | rev | cut -d'/' -f1 --complement | rev)"
fi

if [ ! -d "${controllerpath}" ]
then
    mkdir ${controllerpath}
fi

#cp "${binpath}/reset.bash" "${controllerpath}/"
cp -T "${templatespath}/${modname}.job" "${controllerpath}/controller_${modname}_${controllername}.job"
echo "JobStep,ExitCode,Resubmit?" > ${controllerpath}/skipped 2>/dev/null
echo -e "BatchCounter,StepCounter\n1,1" > ${controllerpath}/batchcounter 2>/dev/null
echo "Pending" > ${controllerpath}/status 2>/dev/null

if [ ! -d "${controllerpath}/jobs" ]
then
    mkdir ${controllerpath}/jobs
fi

files=$(find "${controllerpath}/" -mindepth 1 -type f)
for file in ${files}
    do
        #perl -i -pe 's|#SBATCH(.*)\${CRUNCH_ROOT}|#SBATCH\1'"${CRUNCH_ROOT}"'|g' ${file}
        sed -i "s|path\_to\_module|${modpath}|g" ${file}
        sed -i "s|template|${controllername}|g" ${file}
        #newfile=$(echo "${file}" | sed "s/template/${controllername}/g")
        #mv ${file} ${newfile} 2>/dev/null
    done