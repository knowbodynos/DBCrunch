#!/bin/bash

modulespath="${CRUNCH_ROOT}/modules"
#binpath="${CRUNCH_ROOT}/bin"

modname=$1
controllername=$2

modpath=$(pwd)

if [ ! -d "${modpath}" ]
then
    mkdir ${modpath}
fi

controllerpath="${modpath}/${modname}/${controllername}"

if [ ! -d "${controllerpath}" ]
then
    mkdir ${controllerpath}
fi

#cp "${binpath}/reset.bash" "${controllerpath}/"
cp -T "${modulespath}/templates/${modname}.job" "${controllerpath}/controller_${modname}_${controllername}.job"
echo "JobStep,ExitCode,Resubmit?" > ${controllerpath}/skipped 2>/dev/null
echo -e "BatchCounter,StepCounter\n1,1" > ${controllerpath}/batchcounter 2>/dev/null
echo "Pending" > ${controllerpath}/status 2>/dev/null

if [ ! -d "${controllerpath}/jobs" ]
then
    mkdir ${controllerpath}/jobs
fi

files=$(find "${controllerpath}/" -mindepth 1 -type f)
for file in ${files}
    do
        #perl -i -pe 's|#SBATCH(.*)\${CRUNCH_ROOT}|#SBATCH\1'"${CRUNCH_ROOT}"'|g' ${file}
        sed -i "s|path\_to\_module|${modpath}|g" ${file}
        sed -i "s|template|${controllername}|g" ${file}
        #newfile=$(echo "${file}" | sed "s/template/${controllername}/g")
        #mv ${file} ${newfile} 2>/dev/null
    done