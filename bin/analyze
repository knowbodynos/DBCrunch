#!/bin/bash

ProgDir=$(cd $(dirname "${BASH_SOURCE[0]}"); pwd -P)

SHORTOPTS="j:t:" 
LONGOPTS="job-limit:,time-limit:"

ARGS=$(getopt -s bash --options $SHORTOPTS --longoptions $LONGOPTS -- "$@")

eval set -- "$ARGS"

job_limit=""
time_limit=""

while true
do
    case $1 in
        -j | --job-limit)
            job_limit=$2
            shift
            ;;
        -t | --time-limit)
            time_limit=$2
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "$1 is not a valid option."
            exit 1
            ;;
    esac
    shift
done

modpath=$1
controllerpath=$2
#workpath=$3

modname=$(echo ${modpath} | rev | cut -d'/' -f1 | rev)
controllername=$(echo ${controllerpath} | rev | cut -d'/' -f1 | rev)

tool="analyze.py"
in_path="${controllerpath}/logs"
out_path="${controllerpath}/analyze"
out_file_name="analysis.pdf"

jobid=$(python ${ProgDir}/tools/create_tool.py "${controllerpath}" "${tool}" "${in_path}" "${out_path}" --job-limit "${job_limit}" --time-limit "${time_limit}" --out-files "${out_file_name}")

jobname="crunch_${modname}_${controllername}_analyze"
echo "Submitted batch job ${jobid} as ${jobname}."