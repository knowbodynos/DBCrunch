#!/bin/bash

do_cancel () {
    modpath=$1
    controllerpath=$2
    workpath=$3

    jobs=$(squeue -h -u ${USER} -o '%.10i %.100j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
    if [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | head -c -1 | grep -vE ' CG( |$)' | grep -v '(null)' | grep "crunch_${modname}_${controllername}_" | wc -l)" -ne 0 ]
    then
        while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | head -c -1 | grep -vE ' CG( |$)' | grep -v '(null)' | grep "crunch_${modname}_${controllername}_" | wc -l)" -ne 0 ]
        do
            for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep "crunch_${modname}_${controllername}_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
            do
                scancel ${jobid} 2>/dev/null
            done
            jobs=$(squeue -h -u ${USER} -o '%.10i %.100j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
        done

        echo "Finished cancelling ${modname}_${controllername}."
    fi
}

do_not_dir() {
    path=$1
}

modules_dir=$1
shift

startpath=$(cd ${modules_dir} && pwd -P)

branches=$(find ${startpath} -path '*/.*' -prune -o -type d -exec bash -c 'echo "$(echo '{}' 2>/dev/null | sed "s/\/jobs\$//g" | grep -o / | wc -l) $(echo '{}' 2>/dev/null | sed "s/\/jobs\$//g")"' \; | grep -v '/jobs/' | sort -u | tr '\n' ',')
maxdepth=$(echo ${branches} | tr ',' '\n' | cut -d' ' -f1 | sort -u | tail -n1)
leaves=$(echo ${branches} | tr ',' '\n' | grep "^${maxdepth} " | cut -d' ' -f2 | sed 's/\/jobs$//g' | tr '\n' ',')
moddirpath=$(echo ${leaves} | tr ',' '\n' | rev | cut -d'/' -f1,2 --complement | rev | head -n1)
modnames=($(echo ${leaves} | tr ',' '\n' | rev | cut -d'/' -f2 | rev))
controllernames=($(echo ${leaves} | tr ',' '\n' | rev | cut -d'/' -f1 | rev))

case $# in
    0)
        ;;
    1)
        if [[ "${moddirpath}" == "${startpath}" ]]
        then
            modnames=($1)
            controllernames=()
        else
            stopflag=false
            for i in ${!controllernames[@]}
            do
                if [[ "${controllernames[${i}]}" == "$1" ]]
                then
                    modnames=(${modnames[${i}]})
                    controllernames=(${controllernames[i]})
                    stopflag=true
                    break
                fi
            done
            if ! ${stopflag}
            then
                for modname in ${modnames[@]}
                do
                    if [[ "${modname}" == "$1" ]]
                    then
                        modnames=(${modname})
                        controllernames=()
                        stopflag=true
                        break
                    fi
                done
            fi
            if ! ${stopflag}
            then
                for modname in $(find ${moddirpath} -mindepth 1 -maxdepth 1 -path '*/.*' -prune -o -type d -print 2>/dev/null | rev | cut -d'/' -f1 | rev)
                do
                    if [[ "${modname}" == "$1" ]]
                    then
                        modnames=(${modname})
                        controllernames=()
                        stopflag=true
                        break
                    fi
                done
            fi
            if ! ${stopflag}
            then
                for i in ${!modnames[@]}
                do
                    modnames=(${modnames[${i}]})
                    controllernames=($1)
                done
            fi
        fi
        ;;
    2)
        modnames=($1)
        controllernames=($2)
        ;;
    *)
        echo "Error: You must provide no more than 2 arguments. $# provided."
        exit
        ;;
esac

for i in ${!modnames[@]}
do
    modname=${modnames[${i}]}

    modpath="${moddirpath}/${modname}"

    if [ ! -d "${modpath}" ]
    then
        do_not_dir ${modpath}
    fi

    if [[ "${controllernames[${i}]}" == "" ]]
    then
        controllernames=($(find ${modpath} -mindepth 1 -maxdepth 1 -path '*/.*' -prune -o -type d -print 2>/dev/null | rev | cut -d'/' -f1 | rev))

        for controllername in ${controllernames[@]}
        do
            controllerpath="${modpath}/${controllername}"

            if [ ! -d "${controllerpath}" ]
            then
                do_not_dir ${controllerpath}
            fi

            workpath="${controllerpath}/jobs"

            if [ ! -d "${workpath}" ]
            then
                do_not_dir ${workpath}
            fi

            if [ -d "${modpath}" ] && [ -d "${controllerpath}" ] && [ -d "${workpath}" ]
            then
                do_cancel ${modpath} ${controllerpath} ${workpath}
            fi
        done
    else
        controllername=${controllernames[${i}]}
        controllerpath="${modpath}/${controllername}"

        if [ ! -d "${controllerpath}" ]
        then
            do_not_dir ${controllerpath}
        fi

        workpath="${controllerpath}/jobs"

        if [ ! -d "${workpath}" ]
        then
            do_not_dir ${workpath}
        fi

        if [ -d "${modpath}" ] && [ -d "${controllerpath}" ] && [ -d "${workpath}" ]
        then
            do_cancel ${modpath} ${controllerpath} ${workpath}
        fi
    fi
done