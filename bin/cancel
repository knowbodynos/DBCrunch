#!/bin/bash

startpath=$(cd $1; pwd -P)
origdepth=$(echo ${startpath} | grep -o / | wc -l)
depth=$(find ${startpath} -mindepth 1 -type d -name jobs -exec bash -c 'echo '{}' 2>/dev/null | grep -o / | wc -l' \; -quit)
if [[ "${depth}" == "" ]]
then
    depthdiff=""
else
    depthdiff=$((${depth}-${origdepth}))
fi

case $# in
    1)
        case ${depthdiff} in
            "")
                controllername=$(echo ${startpath} | rev | cut -d'/' -f2 | rev)
                modname=$(echo ${startpath} | rev | cut -d'/' -f3 | rev)

                jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | wc -l)" -ne 0 ]
                do
                    for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep " crunch_${modname}_${controllername}_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
                    do
                        scancel ${jobid} 2>/dev/null
                    done
                    jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                done
                ;;
            1)
                controllername=$(echo ${startpath} | rev | cut -d'/' -f1 | rev)
                modname=$(echo ${startpath} | rev | cut -d'/' -f2 | rev)

                jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | wc -l)" -ne 0 ]
                do
                    for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep " crunch_${modname}_${controllername}_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
                    do
                        scancel ${jobid} 2>/dev/null
                    done
                    jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                done
                ;;
            2)
                modname=$(echo ${startpath} | rev | cut -d'/' -f1 | rev)
                
                jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | wc -l)" -ne 0 ]
                do
                    for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep " crunch_${modname}_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
                    do
                        scancel ${jobid} 2>/dev/null
                    done
                    jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                done
                ;;
            3)
                jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | wc -l)" -ne 0 ]
                do
                    for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep " crunch_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
                    do
                        scancel ${jobid} 2>/dev/null
                    done
                    jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
                done
                ;;
            *)
                echo "Error: You are currently in the ${startpath} directory. You must be inside a modules directory."
                exit 1
                ;;
        esac
        ;;
    2)
        modname=$2

        jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
        while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | wc -l)" -ne 0 ]
        do
            for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep " crunch_${modname}_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
            do
                scancel ${jobid} 2>/dev/null
            done
            jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
        done
        ;;
    3)
        modname=$2
        controllername=$3

        jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
        while [ "$(echo ${jobs} | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | wc -l)" -ne 0 ]
        do
            for jobid in $(echo " ${jobs}" | tr '!' '\n' 2>/dev/null | grep -vE ' CG( |$)' | grep -v '(null)' | grep " crunch_${modname}_${controllername}_" | sed 's/\s\s*/ /g' | cut -d' ' -f2)
            do
                scancel ${jobid} 2>/dev/null
            done
            jobs=$(squeue -h -u ${USER} -o '%.10i %.40j %.2t' 2>/dev/null | head -c -1 | tr '\n' '!')
        done
        ;;
    *)
        echo "Error: You must provide no more than 3 arguments. $# provided."
        exit 1
        ;;
esac