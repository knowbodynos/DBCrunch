#!/bin/bash

case $# in
    1)
        startpath=$(cd $1; pwd -P)

        if [[ "${startpath}" =~ .*"/jobs"$ ]]
        then
            workpath="${startpath}"
            startpath=$(echo ${startpath} | rev | cut -d'/' -f1 --complement | rev)
        else
            workpath="${startpath}/jobs"
        fi

        controllername=$(echo ${startpath} | rev | cut -d'/' -f1 | rev)
        modname=$(echo ${startpath} | rev | cut -d'/' -f2 | rev)
        
        controllerpath="${startpath}"
        modpath=$(echo ${controllerpath} | rev | cut -d'/' -f1 --complement | rev)
        ;;
    2)
        startpath=$(cd $1; pwd -P)
        controllername=$2

        modpath=$(echo ${startpath} | sed -E "s/\/${controllername}(\/.*|$)//g")
        modname=$(echo ${modpath} | rev | cut -d'/' -f1 | rev)
        controllerpath="${modpath}/${controllername}"
        workpath="${controllerpath}/jobs"
        ;;
    3)
        startpath=$(cd $1; pwd -P)
        modname=$2
        controllername=$3

        startpath=$(echo ${startpath} | sed -E "s/\/${modname}(\/.*|$)//g")

        modpath="${startpath}/${modname}"
        controllerpath="${modpath}/${controllername}"
        workpath="${controllerpath}/jobs"
        ;;
esac

if [ ! -d "${modpath}" ]
then
    mkdir ${modpath}
fi

if [ ! -d "${controllerpath}" ]
then
    mkdir ${controllerpath}
fi

if [ ! -d "${workpath}" ]
then
    mkdir ${workpath}
fi

#workpath="${controllerpath}/jobs"
#mongolinkpath="${SLURMONGO_ROOT}/packages/python/mongolink"
#toolspath="${SLURMONGO_ROOT}/scripts/tools"

rm ${controllerpath}/*.out ${controllerpath}/*.err tmp* 2>/dev/null
rm -r ${workpath}/* 2>/dev/null
rm ${controllerpath}/querystate* 2>/dev/null
rm ${controllerpath}/reloadstate* 2>/dev/null

echo "JobStep,ExitCode,Resubmit?" > ${controllerpath}/skipped 2>/dev/null
echo -e "BatchCounter,StepCounter\n1,1" > ${controllerpath}/batchcounter 2>/dev/null
echo "Pending" > ${controllerpath}/status 2>/dev/null

#currdir=$(pwd)
#cd ${mongolinkpath}
#python setup.py install --user --record filespy.txt
#sage --python setup.py install --user --record filessage.txt
#cd ${currdir}

#mongouri=$(cat ${controllerpath}/controller*.job | grep "mongouri=" | cut -d'=' -f2 | sed 's/"//g')
#basecollection=$(cat ${controllerpath}/controller*.job | grep "basecollection=" | cut -d'=' -f2 | sed 's/"//g')
#modname=$(cat ${controllerpath}/controller*.job | grep "modname=" | cut -d'=' -f2 | sed 's/"//g')
#markdone=$(cat ${controllerpath}/controller*.job | grep "markdone=" | cut -d'=' -f2 | sed 's/"//g')
#h11=$(cat ${controllerpath}/controller*.job | grep "h11=" | cut -d'=' -f2 | sed 's/"//g')
#python ${toolspath}/unmark.py "${basecollection}" "${modname}" "${markdone}" "{\"H11\":${h11}}"