#!/bin/bash

ProgName=$(basename "${BASH_SOURCE[0]}")
ProgDir=$(cd $(dirname "${BASH_SOURCE[0]}"); pwd -P)
  
sub_help(){
    echo "Usage: $ProgName [<subcommand>] [options]\n"
    echo "    crunch            Run batch job"
    echo "Subcommands:"
    echo "    crunch cancel     Cancel module or controller jobs"
    echo "    crunch monitor    Monitor all controller jobs"
    echo "    crunch requeue    Requeue jobs skipped by controller"
    echo "    crunch reset      Reset controller for a module"
    echo "    crunch template   Create new controller for a module from a template"
    echo ""
    echo "For help with each subcommand run:"
    echo "$ProgName <subcommand> -h|--help"
    echo ""
}

sub_cancel(){
    ${ProgDir}/cancel ${@}
}

sub_monitor(){
    if [ "$#" -eq 0 ]
    then
        ${ProgDir}/monitor 1
    else
        ${ProgDir}/monitor $1
    fi
}

sub_requeue(){
    if [ ! -d "$1" ]
    then
        ${ProgDir}/requeue $(pwd) ${@}
    else
        ${ProgDir}/requeue ${@}
    fi
}

sub_reset(){
    if [ ! -d "$1" ]
    then
        ${ProgDir}/reset $(pwd) ${@}
    else
        ${ProgDir}/reset ${@}
    fi
}

sub_template(){
    if [ ! -d "$1" ]
    then
        ${ProgDir}/template $(pwd) ${@}
    else
        ${ProgDir}/template ${@}
    fi
}
  
subcommand=$1
case $subcommand in
    "-h" | "--help")
        sub_help
        ;;
    "")
        startpath=$(pwd)

        if [[ "${startpath}" =~ .*"/jobs"$ ]]
        then
            startpath=$(echo ${startpath} | rev | cut -d'/' -f1 --complement | rev)
        fi
        
        controllerpath="${startpath}"

        jobs=$(find ${controllerpath}/ -type f -name "*.job")
        for job in ${jobs}
        do
            sbatch ${job}
        done
        ;;
    *)
        shift
        sub_${subcommand} $@
        if [ $? = 127 ]; then
            echo "Error: '$subcommand' is not a known subcommand." >&2
            echo "       Run '$ProgName --help' for a list of known subcommands." >&2
            exit 1
        fi
        ;;
esac