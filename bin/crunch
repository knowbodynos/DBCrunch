#!/bin/bash

ProgName=$(basename "${BASH_SOURCE[0]}")
ProgDir=$(cd $(dirname "${BASH_SOURCE[0]}"); pwd -P)
  
sub_help(){
    echo "Usage: $ProgName <subcommand> [options]\n"
    echo "Subcommands:"
    echo "    template   Create new controller for a module from a template"
    echo "    reset      Reset controller for a module"
    echo "    requeue    Requeue jobs skipped by controller"
    echo "    monitor    Monitor all controller jobs"
    echo ""
    echo "For help with each subcommand run:"
    echo "$ProgName <subcommand> -h|--help"
    echo ""
}
  
sub_template(){
    if [ ! -d "$1" ]
    then
        ${ProgDir}/template $(pwd) ${@}
    else
        ${ProgDir}/template ${@}
    fi
}
  
sub_reset(){
    if [ ! -d "$1" ]
    then
        ${ProgDir}/reset $(pwd) ${@}
    else
        ${ProgDir}/reset ${@}
    fi
}

sub_requeue(){
    if [ ! -d "$1" ]
    then
        ${ProgDir}/requeue $(pwd) ${@}
    else
        ${ProgDir}/requeue ${@}
    fi
}

sub_monitor(){
    ${ProgDir}/monitor $1
}
  
subcommand=$1
case $subcommand in
    "-h" | "--help")
        sub_help
        ;;
    "")
        jobs=$(find $(pwd)/ -type f -name "*.job")
        for job in ${jobs}
        do
            sbatch ${job}
        done
        ;;
    *)
        shift
        sub_${subcommand} $@
        if [ $? = 127 ]; then
            echo "Error: '$subcommand' is not a known subcommand." >&2
            echo "       Run '$ProgName --help' for a list of known subcommands." >&2
            exit 1
        fi
        ;;
esac